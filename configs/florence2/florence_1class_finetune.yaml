# Florence-2 Fine-tuned Configuration for Tomato_merge
# Fine-tuned model on Tomato_merge dataset (1-class)

experiment:
  name: florence2_tomato_merge_finetuned_exp001
  seed: 42
  save_dir: exp
  log_image_enabled: true
  log_image_interval: 5

model:
  arch_name: florence2
  model_name: microsoft/Florence-2-base
  num_labels: 1
  learning_rate: 2.0e-05     
  weight_decay: 0.0001      

florence2:
  mode: finetuned
  model_name: microsoft/Florence-2-base
  checkpoint_path: exp/florence2/Tomato_merge_1_florence2_latest/checkpoints/best
  
  # Fine-tuning 후 클래스 맵
  class_map:
    0: tomato
  
  # Bucketed batching 설정 (Valid labels 증가를 위해)
  use_bucketed_batching: true
  bucket_boundaries: [4, 8, 13]  # 버킷 경계: [1-3], [4-7], [8-12], [13+]
  max_objects_per_image: null    # 최대 객체 수 제한 (null이면 제한 없음)
  
  # LoRA Fine-tuning 설정
  use_lora: true
  lora_r: 32              # 64 → 32 (overfitting 방지)
  lora_alpha: 32          # 64 → 32
  lora_dropout: 0.05         
  
  # Letterbox resize 설정
  use_letterbox: true     # Aspect ratio 유지하며 resize
  
  # 데이터 증강 범위 설정 (초기에는 보수적으로 설정)
  augmentation:
    brightness_range: [0.85, 1.15]  
    contrast_range: [0.9, 1.1] 
    saturation_range: [0.9, 1.1] 
  
  # Generation 파라미터
  generation:
    max_new_tokens: 512
    num_beams: 1
    do_sample: false
    use_cache: false
  
  # Confidence threshold
  conf_threshold: 0.6
  nms_threshold: 0.5

training:
  epochs: 300              
  patience: 30           
  gradient_clip_val: 1.0   
  accumulate_grad_batches: 1
  
  # Learning rate schedule
  lr_scheduler: cosine     # 'linear' or 'cosine'
  warmup_ratio: 0.1        # Warmup 비율 (전체 step의 10%)
  
  # Training settings
  save_best: true
  save_last: true
  save_period: -1           # 주기적 저장 비활성화 (best/last만 저장)
  
  # Validation settings
  val: true                 # validate during training
  
  # Advanced settings
  amp: true                 # Automatic Mixed Precision training
  profile: false

data:
  dataset_name: Tomato_merge_1
  num_classes: 1
  class_names:
    - tomato
  
  # Paths
  data_root: data/Tomato_merge_1
  train_dir: data/Tomato_merge_1/train
  val_dir: data/Tomato_merge_1/val
  test_dir: data/Tomato_merge_1/test

  # Annotations
  train_ann_file: custom_train.json
  val_ann_file: custom_val.json
  test_ann_file: custom_test.json
  
  # DataLoader settings (최종 개선)
  batch_size: 32           
  num_workers: 8            
  pin_memory: true

evaluation:
  score_threshold: 0.0
  iou_threshold: 0.5
  nms_threshold: 0.5
  max_detections: 100
  batch_size: 1

test:
  show_gt: false
  box_color_mode: model

# 디바이스 설정
device: cuda

# 로깅
logging:
  verbose: true
  tensorboard:
    enabled: true      
  csv:
    enabled: true       
  save_log_file: true   

hardware:
  device: cuda

